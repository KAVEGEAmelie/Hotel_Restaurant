services:
  - type: web
    name: hotel-restaurant-le-printemps
    runtime: node
    plan: free
    region: frankfurt
    buildCommand: |
      # Installer PHP via gestionnaire de paquets Node
      curl -sL https://deb.nodesource.com/setup_18.x | sudo bash -
      sudo apt-get update
      
      # Installer PHP 8.2 et extensions nécessaires
      sudo apt-get install -y software-properties-common
      sudo add-apt-repository -y ppa:ondrej/php
      sudo apt-get update
      sudo apt-get install -y php8.2-cli php8.2-curl php8.2-mbstring php8.2-xml php8.2-zip php8.2-pgsql php8.2-gd php8.2-bcmath
      
      # Installer Composer globalement
      curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer
      
      # Copier la configuration d'environnement
      cp .env.production .env 2>/dev/null || echo "APP_ENV=production" > .env
      echo "APP_KEY=base64:Xmj2ol9FNXacWfCgPDNCNacKvWngXgbmrL2j6EUWc+0=" >> .env
      
      # Installer les dépendances PHP
      composer install --no-dev --optimize-autoloader --no-interaction
      
      # Installer les dépendances Node.js et builder les assets
      npm install
      npm run build
      
      # Optimiser Laravel
      php artisan key:generate --force
      php artisan config:cache
      php artisan route:cache
      php artisan view:cache
    startCommand: php artisan serve --host=0.0.0.0 --port=$PORT
    envVars:
      - key: APP_ENV
        value: production
      - key: APP_DEBUG
        value: "false"
      - key: APP_KEY
        value: base64:Xmj2ol9FNXacWfCgPDNCNacKvWngXgbmrL2j6EUWc+0=
      - key: APP_URL
        value: https://hotel-restaurant-le-printemps.onrender.com
      - key: LOG_CHANNEL
        value: stderr

databases:
  - name: db-hotel-printemps
    plan: free
    databaseName: hotel_printemps
    user: laravel_user
